#!/usr/bin/env python3

# ==============================================================================
# MONTHLY MAINTENANCE INSTALLER (FIXED SCROLLING v6.2)
# ==============================================================================

import sys
import os
import time
import shutil
import threading
import stat
import subprocess
import re

# --- 0. DETACH FROM TERMINAL LOGIC ---
if os.isatty(sys.stdin.fileno()):
    subprocess.Popen(
        [sys.executable, os.path.abspath(__file__)],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        stdin=subprocess.DEVNULL,
        start_new_session=True
    )
    sys.exit(0)

# --- 1. DEPENDENCY CHECK ---
try:
    import gi
    gi.require_version('Gtk', '4.0')
    gi.require_version('Adw', '1')
    from gi.repository import Gtk, Adw, GLib, Gio, Gdk
except Exception as e:
    try:
        subprocess.run(['notify-send', 'Installer Error', 
                        f'Missing Libadwaita/GTK4.\n{e}', '--urgency=critical'])
    except: pass
    sys.exit(1)

# --- CONSTANTS ---
APP_NAME = 'Monthly Maintenance'
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
SOURCE_FILE = os.path.join(SCRIPT_DIR, 'sources', 'monthly-maintenance')

BIN_DIR = os.path.expanduser('~/.local/bin')
APP_DIR = os.path.expanduser('~/.local/share/applications')
AUTOSTART_DIR = os.path.expanduser('~/.config/autostart')
CONFIG_DIR = os.path.expanduser('~/.config/monthly-updater')

TARGET_BIN = os.path.join(BIN_DIR, 'monthly-maintenance')
TARGET_DESKTOP = os.path.join(APP_DIR, 'monthly-maintainer.desktop')
TARGET_AUTOSTART = os.path.join(AUTOSTART_DIR, 'monthly-maintainer.desktop')

# --- HELPERS ---
def get_source_version():
    if not os.path.exists(SOURCE_FILE): return 'Unknown'
    try:
        with open(SOURCE_FILE, 'r') as f: c = f.read()
        m = re.search(r'APP_VERSION="([^"]+)"', c)
        return m.group(1) if m else 'Unknown'
    except: return 'Unknown'

def get_installed_version():
    if not os.path.exists(TARGET_BIN): return None
    try:
        with open(TARGET_BIN, 'r') as f: c = f.read()
        m = re.search(r'APP_VERSION="([^"]+)"', c)
        return m.group(1) if m else 'Unknown'
    except: pass
    return 'Unknown'

SRC_VER = get_source_version()

# --- GUI CLASS ---
class InstallerWindow(Adw.Window):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.set_title('Setup Wizard')
        self.set_default_size(500, 650)
        
        # Add custom CSS for the link color
        css_provider = Gtk.CssProvider()
        css_provider.load_from_data(b"label.license-text link { color: #3584e4; }")
        Gtk.StyleContext.add_provider_for_display(
            Gdk.Display.get_default(), css_provider, Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION
        )
        
        self.nav = Adw.NavigationView()
        self.set_content(self.nav)
        
        self.create_pages()
        self.nav.add(self.page_welcome)
        self.check_installed_state()

    def create_pages(self):
        # 1. WELCOME PAGE
        self.page_welcome = Adw.NavigationPage(title='Welcome', tag='welcome')
        box1 = self.create_base_layout()
        self.page_welcome.set_child(box1['root'])
        
        self.hero = Adw.StatusPage()
        self.hero.set_icon_name('system-software-install-symbolic')
        self.hero.set_title('Monthly Maintenance')
        self.hero.set_description('Setup Wizard')
        box1['content'].append(self.hero)
        
        self.btn_install = self.create_main_button('Install', 'suggested-action', self.on_goto_options)
        self.btn_repair = self.create_main_button('Repair', 'suggested-action', self.on_goto_options)
        self.btn_uninstall = self.create_main_button('Uninstall', 'destructive-action', self.on_uninstall_click)
        
        box1['content'].append(self.btn_install)
        box1['content'].append(self.btn_repair)
        box1['content'].append(self.btn_uninstall)

        # 2. OPTIONS PAGE
        self.page_options = Adw.NavigationPage(title='Configuration', tag='options')
        box2 = self.create_base_layout()
        self.page_options.set_child(box2['root'])
        
        # --- LICENSE TEXT (Standalone Label) ---
        lic_label = Gtk.Label(xalign=0, wrap=True)
        lic_label.set_markup(
            "<span size='large' weight='bold'>Terms &amp; License</span>\n\n"
            "This software is open source, licensed under the "
            "<a href='https://www.gnu.org/licenses/old-licenses/gpl-2.0.html'>GPLv2 License</a>.\n\n"
            "<span size='small' color='gray'>THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND, "
            "EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY.</span>"
        )
        lic_label.add_css_class("license-text")
        lic_label.set_margin_bottom(20)
        lic_label.set_margin_start(10)
        lic_label.set_margin_end(10)
        box2['content'].append(lic_label)
        
        # Settings Group
        opt_group = Adw.PreferencesGroup()
        opt_group.set_title("Installation Options")
        box2['content'].append(opt_group)
        
        # Checkbox 1
        self.chk_install = Gtk.CheckButton()
        self.chk_install.set_active(True)
        self.chk_install.set_sensitive(False)
        row_inst = Adw.ActionRow()
        row_inst.set_title("Install Application")
        row_inst.set_subtitle(f"Install v{SRC_VER} to ~/.local/bin")
        row_inst.add_prefix(self.chk_install)
        opt_group.add(row_inst)
        
        # Checkbox 2
        self.chk_autostart = Gtk.CheckButton()
        self.chk_autostart.set_active(True)
        row_auto = Adw.ActionRow()
        row_auto.set_title("Run on Startup")
        row_auto.set_subtitle("Launch automatically when you login")
        row_auto.add_prefix(self.chk_autostart)
        row_auto.set_activatable_widget(self.chk_autostart)
        opt_group.add(row_auto)
        
        btn_confirm = self.create_main_button('Accept & Install', 'suggested-action', self.on_start_install)
        box2['content'].append(btn_confirm)

        # 3. PROGRESS PAGE (Fixed Layout Logic)
        self.page_progress = Adw.NavigationPage(title='Installing', tag='progress')
        self.page_progress.set_can_pop(False) 
        
        # Use ToolbarView for proper background styling
        prog_root = Adw.ToolbarView()
        prog_header = Adw.HeaderBar()
        prog_root.add_top_bar(prog_header)
        self.page_progress.set_child(prog_root)
        
        # Main Vertical Layout
        prog_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        prog_root.set_content(prog_box)
        
        # 3a. FIXED HEADER (Icon + Title)
        self.prog_status = Adw.StatusPage()
        self.prog_status.set_title('Working...')
        self.prog_status.set_icon_name('system-software-install-symbolic')
        self.prog_status.set_vexpand(False) 
        self.prog_status.set_margin_top(30)
        self.prog_status.set_margin_bottom(20)
        prog_box.append(self.prog_status)
        
        # 3b. SCROLLABLE CONTENT (The List + Button)
        prog_scroll = Gtk.ScrolledWindow()
        prog_scroll.set_vexpand(True)
        prog_box.append(prog_scroll)
        
        prog_clamp = Adw.Clamp(maximum_size=450, margin_bottom=24, margin_start=12, margin_end=12)
        prog_scroll.set_child(prog_clamp)
        
        prog_content = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        prog_clamp.set_child(prog_content)
        
        self.prog_group = Adw.PreferencesGroup()
        prog_content.append(self.prog_group)
        
        self.row_1 = self.create_progress_row('System Check')
        self.row_2 = self.create_progress_row('Copying Files')
        self.row_3 = self.create_progress_row('Registering App')
        self.row_4 = self.create_progress_row('Configuring Autostart')
        
        # Close button starts hidden
        self.btn_close = self.create_main_button('Close', 'suggested-action', lambda x: self.close())
        self.btn_close.set_visible(False) 
        prog_content.append(self.btn_close)

    # --- UI FACTORY ---
    def create_base_layout(self):
        root = Adw.ToolbarView()
        header = Adw.HeaderBar()
        root.add_top_bar(header)
        
        scroll = Gtk.ScrolledWindow()
        root.set_content(scroll)
        
        clamp = Adw.Clamp(maximum_size=450, margin_top=24, margin_bottom=24, margin_start=12, margin_end=12)
        scroll.set_child(clamp)
        content = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=20)
        clamp.set_child(content)
        return {'root': root, 'content': content}

    def create_main_button(self, label, css, callback):
        btn = Gtk.Button(label=label)
        btn.add_css_class('pill')
        btn.add_css_class(css)
        btn.set_size_request(-1, 50)
        btn.connect('clicked', callback)
        return btn

    def create_progress_row(self, title):
        row = Adw.ActionRow()
        row.set_title(title)
        spinner = Gtk.Spinner()
        spinner.set_visible(False)
        icon = Gtk.Image.new_from_icon_name('object-select-symbolic')
        icon.add_css_class('success')
        icon.set_visible(False)
        row.add_suffix(spinner)
        row.add_suffix(icon)
        self.prog_group.add(row)
        row._spinner = spinner
        row._icon = icon
        return row

    # --- LOGIC ---
    def check_installed_state(self):
        curr_ver = get_installed_version()
        if curr_ver:
            self.hero.set_description(f'Version {curr_ver} Installed')
            self.btn_install.set_visible(False)
            self.btn_repair.set_visible(True)
            self.btn_uninstall.set_visible(True)
            if str(SRC_VER) != str(curr_ver):
                self.btn_repair.set_label(f'Update to v{SRC_VER}')
        else:
            self.hero.set_description('Ready to Install')
            self.btn_install.set_visible(True)
            self.btn_repair.set_visible(False)
            self.btn_uninstall.set_visible(False)
            if not os.path.exists(SOURCE_FILE):
                self.btn_install.set_sensitive(False)
                self.btn_install.set_label('Source File Missing!')

    def on_goto_options(self, btn):
        self.nav.push(self.page_options)

    def on_start_install(self, btn):
        do_autostart = self.chk_autostart.get_active()
        self.nav.push(self.page_progress)
        thread = threading.Thread(target=self.run_process, args=('install', do_autostart))
        thread.daemon = True
        thread.start()

    def on_uninstall_click(self, btn):
        self.nav.push(self.page_progress)
        self.prog_status.set_title('Uninstalling...')
        self.prog_status.set_icon_name('user-trash-symbolic')
        thread = threading.Thread(target=self.run_process, args=('uninstall', False))
        thread.daemon = True
        thread.start()

    def set_row_state(self, row, state):
        def _u():
            if state == 'run':
                row._spinner.set_visible(True); row._spinner.start(); row._icon.set_visible(False)
            elif state == 'ok':
                row._spinner.stop(); row._spinner.set_visible(False)
                row._icon.set_from_icon_name('object-select-symbolic'); row._icon.set_visible(True)
            elif state == 'trash':
                row._spinner.stop(); row._spinner.set_visible(False)
                row._icon.set_from_icon_name('user-trash-symbolic'); row._icon.set_visible(True)
        GLib.idle_add(_u)

    def run_process(self, mode, do_autostart):
        # 1. System Check
        self.set_row_state(self.row_1, 'run'); time.sleep(0.5)
        os.makedirs(BIN_DIR, exist_ok=True)
        os.makedirs(APP_DIR, exist_ok=True)
        os.makedirs(AUTOSTART_DIR, exist_ok=True)
        self.set_row_state(self.row_1, 'ok')

        # 2. Files
        self.set_row_state(self.row_2, 'run'); time.sleep(0.5)
        if mode == 'install':
            if os.path.exists(SOURCE_FILE):
                shutil.copy2(SOURCE_FILE, TARGET_BIN)
                st = os.stat(TARGET_BIN)
                os.chmod(TARGET_BIN, st.st_mode | stat.S_IEXEC)
                self.set_row_state(self.row_2, 'ok')
            else: self.set_row_state(self.row_2, 'trash')
        else:
            if os.path.exists(TARGET_BIN): os.remove(TARGET_BIN)
            if os.path.exists(CONFIG_DIR): shutil.rmtree(CONFIG_DIR)
            self.set_row_state(self.row_2, 'trash')

        # 3. Register App
        self.set_row_state(self.row_3, 'run'); time.sleep(0.3)
        if mode == 'install':
            with open(TARGET_DESKTOP, 'w') as f:
                f.write(f'''[Desktop Entry]
Type=Application
Name={APP_NAME}
Comment=System Update Manager
Exec=bash "{TARGET_BIN}" --run-gui
Icon=software-update-available-symbolic
Terminal=false
Categories=System;Settings;
''')
            subprocess.call(['update-desktop-database', APP_DIR])
            self.set_row_state(self.row_3, 'ok')
        else:
            if os.path.exists(TARGET_DESKTOP): os.remove(TARGET_DESKTOP)
            subprocess.call(['update-desktop-database', APP_DIR])
            self.set_row_state(self.row_3, 'trash')

        # 4. Autostart
        self.set_row_state(self.row_4, 'run'); time.sleep(0.4)
        if mode == 'install':
            if do_autostart:
                with open(TARGET_AUTOSTART, 'w') as f:
                    f.write(f'''[Desktop Entry]
Type=Application
Name={APP_NAME} Monitor
Exec=bash "{TARGET_BIN}" --check-silent
Icon=software-update-available-symbolic
Terminal=false
Hidden=false
NoDisplay=true
X-GNOME-Autostart-enabled=true
''')
                self.set_row_state(self.row_4, 'ok')
            else:
                if os.path.exists(TARGET_AUTOSTART): os.remove(TARGET_AUTOSTART)
                self.set_row_state(self.row_4, 'ok')
        else:
            if os.path.exists(TARGET_AUTOSTART): os.remove(TARGET_AUTOSTART)
            self.set_row_state(self.row_4, 'trash')

        GLib.idle_add(self.on_done, mode)

    def on_done(self, mode):
        # Reveal close button only now
        self.btn_close.set_visible(True)
        
        if mode == 'install':
            self.prog_status.set_title('Complete')
            self.prog_status.set_description('Installation Successful')
            self.prog_status.set_icon_name('object-select-symbolic')
            self.prog_status.add_css_class('success')
        else:
            self.prog_status.set_title('Uninstalled')
            self.prog_status.set_description('Cleanup Complete')
            self.prog_status.set_icon_name('user-trash-symbolic')

class App(Adw.Application):
    def __init__(self): super().__init__(application_id='com.local.Installer', flags=Gio.ApplicationFlags.FLAGS_NONE)
    def do_activate(self): InstallerWindow(application=self).present()

if __name__ == '__main__': App().run(sys.argv)
