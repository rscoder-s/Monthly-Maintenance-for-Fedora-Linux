#!/bin/bash

# ==============================================================================
# FEDORA MONTHLY MAINTENANCE
# ==============================================================================

APP_VERSION="0.1.0"
CONFIG_DIR="$HOME/.config/monthly-updater"
LOG_FILE="$CONFIG_DIR/maintenance.log"
STATE_FILE="$CONFIG_DIR/last_successful_update"
CURRENT_MONTH=$(date +%Y-%m)
SCRIPT_PATH=$(realpath "$0")
DESKTOP_FILE_NAME="monthly-maintainer.desktop"
DESKTOP_FILE_PATH="$HOME/.local/share/applications/$DESKTOP_FILE_NAME"

# Ensure directories exist
mkdir -p "$CONFIG_DIR"
mkdir -p "$HOME/.local/share/applications"

# --- HELPER: LOGGING ---
log_event() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# --- CHECK: GUI DEPENDENCIES ---
check_gui_support() {
    if command -v python3 &>/dev/null; then
        if python3 -c "import gi; gi.require_version('Adw', '1')" &>/dev/null; then
            return 0
        fi
    fi
    return 1
}

# --- HELPER: ENSURE DESKTOP SHORTCUT EXISTS ---
ensure_permanent_shortcut() {
    cat > "$DESKTOP_FILE_PATH" <<EOF
[Desktop Entry]
Type=Application
Name=Monthly Maintenance
Comment=System Update Manager
Exec=bash "$SCRIPT_PATH" --run-gui
Icon=software-update-available-symbolic
Terminal=false
Categories=System;Settings;
Keywords=update;upgrade;dnf;flatpak;
EOF
    update-desktop-database "$HOME/.local/share/applications" &> /dev/null
}

# --- HELPER: LAUNCHER FUNCTION ---
launch_update_process() {
    if check_gui_support; then
        log_event "ACTION: Direct Launch -> GUI Mode"
        run_gui_mode
    else
        log_event "ACTION: Gio Launch -> Terminal Mode"
        create_terminal_desktop_file
        gio launch "$DESKTOP_FILE_PATH"
    fi
}

create_terminal_desktop_file() {
cat > "$DESKTOP_FILE_PATH" <<EOF
[Desktop Entry]
Type=Application
Name=Monthly Maintenance
Exec=bash "$SCRIPT_PATH" --run-terminal
Terminal=true
NoDisplay=true
Icon=software-update-available-symbolic
EOF
update-desktop-database "$HOME/.local/share/applications" &> /dev/null
}

# ==============================================================================
# MODE: TERMINAL FALLBACK
# ==============================================================================
run_terminal_mode() {
    log_event "START: Terminal Fallback Mode."
    echo "------------------------------------------------"
    echo "      FEDORA MONTHLY MAINTENANCE (CLI)          "
    echo "------------------------------------------------"

    echo ">> [1/3] System Updates..."
    if sudo dnf update -y; then
        log_event "SUCCESS: DNF finished."
    else
        log_event "FAILURE: DNF failed."
        echo "!!! DNF Failed. Press Enter to exit..."
        read
        exit 1
    fi

    echo ">> [2/3] Flatpaks..."
    flatpak update -y
    
    echo ">> [3/3] Distrobox..."
    distrobox-upgrade --all

    echo "$CURRENT_MONTH" > "$STATE_FILE"
    log_event "STATE CHANGE: Marked $CURRENT_MONTH as complete."
    
    echo "MAINTENANCE COMPLETE. Closing in 5s..."
    sleep 5
    exit 0
}

# ==============================================================================
# MODE: GUI EXECUTION (Python Embedded)
# ==============================================================================
run_gui_mode() {
    export UPDATER_LOG_FILE="$LOG_FILE"
    export CURRENT_MONTH_TAG="$CURRENT_MONTH"
    export STATE_FILE_PATH="$STATE_FILE"

    exec python3 -c "
import sys, os, subprocess, threading, datetime, signal, gi
try:
    gi.require_version('Gtk', '4.0')
    gi.require_version('Adw', '1')
    from gi.repository import Gtk, Adw, GLib, Gio, Pango
except: sys.exit(1)

APP_ID = 'com.local.MonthlyUpdater'
LOG_FILE = os.environ.get('UPDATER_LOG_FILE', '/tmp/updater.log')
TARGET_MONTH_RAW = os.environ.get('CURRENT_MONTH_TAG', '2025-01')
STATE_FILE = os.environ.get('STATE_FILE_PATH', '/tmp/state')

# --- DATE LOGIC ---
try:
    if os.path.exists(STATE_FILE):
        with open(STATE_FILE, 'r') as f:
            raw_date = f.read().strip()
        last_dt = datetime.datetime.strptime(raw_date + '-01', '%Y-%m-%d')
        fmt_date = last_dt.strftime('%B %Y')
        SUBTITLE_TEXT = f'Updates since {fmt_date}'
    else:
        SUBTITLE_TEXT = 'Initial System Setup'
except Exception:
    SUBTITLE_TEXT = 'System Update'

def log_to_file(msg):
    ts = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    with open(LOG_FILE, 'a') as f: f.write(f'[{ts}] [GUI] {msg}\n')

class UpdaterWindow(Adw.Window):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.set_title('Monthly Maintenance')
        self.set_default_size(500, 600)
        
        self.main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        self.set_content(self.main_box)
        
        self.header = Adw.HeaderBar()
        self.main_box.append(self.header)
        
        self.clamp = Adw.Clamp()
        self.clamp.set_maximum_size(450)
        self.clamp.set_margin_top(20)
        self.clamp.set_margin_bottom(20)
        self.clamp.set_margin_start(12)
        self.clamp.set_margin_end(12)
        self.main_box.append(self.clamp)
        
        self.content_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        self.clamp.set_child(self.content_box)

        self.header_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        self.header_box.set_margin_bottom(12)
        
        self.icon = Gtk.Image.new_from_icon_name('software-update-available-symbolic')
        self.icon.set_pixel_size(96)
        self.icon.add_css_class('accent') 
        self.header_box.append(self.icon)
        
        self.title_label = Gtk.Label(label='System Update')
        self.title_label.add_css_class('title-1')
        self.header_box.append(self.title_label)
        
        self.subtitle_label = Gtk.Label(label=SUBTITLE_TEXT)
        self.subtitle_label.add_css_class('title-3')
        self.subtitle_label.add_css_class('dim-label')
        self.header_box.append(self.subtitle_label)
        
        self.content_box.append(self.header_box)

        self.group = Adw.PreferencesGroup()
        self.content_box.append(self.group)

        self.row_dnf = self.add_row('System Updates (DNF)', 'security-high-symbolic')
        self.row_flatpak = self.add_row('Flatpaks', 'applications-system-symbolic')
        self.row_distrobox = self.add_row('Distrobox Containers', 'package-x-generic-symbolic')

        self.expander = Adw.ExpanderRow()
        self.expander.set_title('Details')
        self.expander.set_subtitle('View update logs')
        
        scroll = Gtk.ScrolledWindow()
        scroll.set_min_content_height(150)
        scroll.set_propagate_natural_height(True)
        scroll.set_has_frame(True)
        
        self.view = Gtk.TextView()
        self.view.set_editable(False)
        self.view.set_monospace(True)
        self.view.set_top_margin(8)
        self.view.set_bottom_margin(8)
        self.view.set_left_margin(8)
        self.view.set_right_margin(8)
        
        self.buff = self.view.get_buffer()
        self.buff.set_text('Ready to start updates...\\nWaiting for user confirmation.')
        
        scroll.set_child(self.view)
        self.expander.add_row(scroll)
        self.group.add(self.expander)

        self.btn = Gtk.Button(label='Start Update')
        self.btn.add_css_class('pill')
        self.btn.add_css_class('suggested-action')
        self.btn.set_size_request(-1, 50) 
        self.btn.connect('clicked', self.start)
        self.content_box.append(self.btn)
        self.running = False

    def add_row(self, title, icon):
        row = Adw.ActionRow()
        row.set_title(title)
        row.add_prefix(Gtk.Image.new_from_icon_name(icon))
        row.icon = Gtk.Image.new_from_icon_name('emoji-body-symbolic')
        row.icon.set_visible(False)
        row.spinner = Gtk.Spinner()
        row.spinner.set_visible(False)
        row.add_suffix(row.spinner)
        row.add_suffix(row.icon)
        self.group.add(row)
        return row

    def log(self, t):
        GLib.idle_add(lambda: self.buff.insert(self.buff.get_end_iter(), t+'\\n'))
        log_to_file(t)

    def set_state(self, row, s):
        def _u():
            if s=='run': 
                row.spinner.start(); row.spinner.set_visible(True); row.icon.set_visible(False)
            elif s=='ok':
                row.spinner.stop(); row.spinner.set_visible(False); row.icon.set_visible(True)
                row.icon.set_from_icon_name('emoji-body-symbolic'); row.icon.add_css_class('success')
            elif s=='err':
                row.spinner.stop(); row.spinner.set_visible(False); row.icon.set_visible(True)
                row.icon.set_from_icon_name('dialog-error-symbolic'); row.icon.add_css_class('error')
        GLib.idle_add(_u)

    def start(self, b):
        if self.running: return
        self.running = True
        self.btn.set_sensitive(False)
        self.buff.set_text('') 
        threading.Thread(target=self.run_process, daemon=True).start()

    def run_cmd(self, cmd, row):
        self.set_state(row, 'run')
        self.log(f'> RUN: {cmd}')
        try:
            p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, bufsize=1)
            for l in p.stdout: self.log(l.strip())
            p.wait()
            if p.returncode==0: self.set_state(row, 'ok'); return True
            else: self.set_state(row, 'err'); return False
        except Exception as e:
            self.log(f'ERR: {e}'); self.set_state(row, 'err'); return False

    def run_process(self):
        ok = True
        if not self.run_cmd(['pkexec','dnf','update','-y'], self.row_dnf): ok = False
        if not self.run_cmd(['flatpak','update','-y'], self.row_flatpak): ok = False
        if not self.run_cmd(['distrobox-upgrade','--all'], self.row_distrobox): ok = False

        if ok:
            self.log('DONE SUCCESS')
            try: open(STATE_FILE, 'w').write(TARGET_MONTH_RAW)
            except: pass
            GLib.idle_add(self.done, True)
        else:
            self.log('DONE ERRORS')
            GLib.idle_add(self.done, False)

    def done(self, success):
        self.title_label.set_label('Complete!' if success else 'Failed')
        self.icon.set_from_icon_name('emoji-body-symbolic' if success else 'dialog-error-symbolic')
        self.icon.remove_css_class('accent')
        self.icon.add_css_class('success' if success else 'error')
        self.btn.set_label('Close')
        self.btn.set_sensitive(True)
        self.btn.remove_css_class('suggested-action')
        self.btn.connect('clicked', lambda x: self.close())
        subprocess.Popen(['pkill', '-f', 'monthly-maintenance'])

class App(Adw.Application):
    def __init__(self): super().__init__(application_id=APP_ID, flags=Gio.ApplicationFlags.FLAGS_NONE)
    def do_activate(self): UpdaterWindow(application=self).present()

if __name__ == '__main__': App().run(sys.argv)
"
    exit 0
}

# ==============================================================================
# MAIN ROUTER LOGIC
# ==============================================================================

ensure_permanent_shortcut

if [ "$1" == "--run-terminal" ]; then
    run_terminal_mode
fi

if [ "$1" == "--run-gui" ]; then
    run_gui_mode
fi

# ==============================================================================
# CHECK / NOTIFICATION LOGIC
# ==============================================================================

NEEDS_UPDATE="yes"
if [ -f "$STATE_FILE" ]; then
    LAST_REC=$(cat "$STATE_FILE")
    if [ "$LAST_REC" == "$CURRENT_MONTH" ]; then
        NEEDS_UPDATE="no"
    fi
fi

# --- MODE: SILENT CHECK ---
if [ "$1" == "--check-silent" ]; then
    if [ "$NEEDS_UPDATE" == "no" ]; then
        exit 0
    fi
fi

# --- MODE: MANUAL CHECK ---
if [ "$1" == "" ] && [ "$NEEDS_UPDATE" == "no" ]; then
    nohup bash -c "
        RESPONSE_HEALTHY=\$(notify-send \
            'System Healthy' \
            'You are up to date. Click to open app.' \
            --icon=security-high \
            --urgency=low \
            --action='default=Open App' \
            --wait)
        
        if [ \"\$RESPONSE_HEALTHY\" == \"default\" ]; then
            $SCRIPT_PATH --run-gui
        fi
    " >/dev/null 2>&1 &
    exit 0
fi

# ==============================================================================
# NOTIFICATION LOGIC (Update Required)
# ==============================================================================
log_event "NOTIFY: Update required ($CURRENT_MONTH)."

nohup bash -c "
    RESPONSE=\$(notify-send \
        'Monthly Update Required' \
        'Updates pending for $CURRENT_MONTH. Click to start.' \
        --icon=software-update-available \
        --urgency=critical \
        --action='default=Update Now' \
        --wait)

    if [ \"\$RESPONSE\" == \"default\" ]; then
        $SCRIPT_PATH --run-gui
    else
        RESPONSE_PASSIVE=\$(notify-send \
            'Update Postponed' \
            'Maintenance is pending. Click to restart.' \
            --icon=dialog-warning \
            --urgency=low \
            --action='default=Update Now' \
            --wait)
            
        if [ \"\$RESPONSE_PASSIVE\" == \"default\" ]; then
            $SCRIPT_PATH --run-gui
        fi
    fi
" >/dev/null 2>&1 &

exit 0
